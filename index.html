<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transmedia Sales Tracker</title>
    <style>
        :root { --primary:#2563eb; --bg:#f8fafc; --border:#e2e8f0; }
        body { font-family: Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        #authOverlay { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 2000; color: white; }
        .auth-card { background: white; color: #1e293b; padding: 30px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; }
        .auth-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 16px 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); gap: 15px; flex-wrap: wrap; }
        .controls { display: flex; gap: 10px; align-items: center; flex-grow: 1; justify-content: flex-end; flex-wrap: wrap; }
        #searchInput { padding: 10px; border: 1px solid var(--border); border-radius: 8px; width: 100%; max-width: 250px; font-size: 14px; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .table-container { background: white; border-radius: 12px; overflow: auto; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 2200px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 11px; color: #475569; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 12px; color: #1e293b; }
        .badge { padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 11px; display: inline-block; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        /* 50-Day Warning Style */
        .expiry-warning { background-color: #fff7ed !important; border-left: 5px solid #f97316; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.open { display: flex; }
        .modal { background: white; width: 95%; max-width: 1100px; border-radius: 16px; padding: 25px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        input, select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; width: 100%; box-sizing: border-box; }
        label { font-size: 11px; font-weight: bold; color: #64748b; display: block; margin-bottom: 4px; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-card">
        <h2>Transmedia CRM</h2>
        <input type="email" id="loginEmail" placeholder="Email Address">
        <input type="password" id="loginPass" placeholder="Password">
        <button class="btn" style="width:100%" onclick="handleLogin()">Sign In</button>
        <p id="errorMsg" style="color:red; font-size:12px; display:none; margin-top:10px;"></p>
    </div>
</div>

<header>
    <h2>Transmedia Sales Tracker</h2>
    <div class="controls">
        <input type="text" id="searchInput" placeholder="Search..." onkeyup="filterTable()">
        <button class="btn" style="background:#059669;" onclick="exportToCSV()">üìä Export CSV</button>
        <button class="btn" onclick="openModal()">+ Add New Entry</button>
        <button class="btn" style="background:#64748b;" onclick="handleLogout()">Logout</button>
    </div>
</header>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Client Name</th><th>Customer Name</th><th>Speed</th><th>Location</th><th>Connectivity</th>
                <th>Status</th><th>Months</th><th>Devices</th><th>Price for 1 device</th><th>Total exclusive gst</th>
                <th>Total inclusive gst</th><th>Payment Status</th><th>Payment Date</th><th>Start Date</th>
                <th>End Date</th><th>PO Expiry</th><th>Service Status</th><th>Service Stop Date</th><th>PO Renewed?</th><th>Renewal Date</th><th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h3 style="margin-top:0;">Entry Details</h3>
        <form id="salesForm">
            <div class="form-grid">
                <div><label>Client Name</label><input name="clientName" required></div>
                <div><label>Customer Name</label><input name="customerName" required></div>
                <div><label>Speed</label><input name="speed"></div>
                <div><label>Location</label><input name="location"></div>
                <div><label>Connectivity</label>
                    <select name="connectivity">
                        <option value="Enterprise Wi-Fi">Enterprise Wi-Fi</option>
                        <option value="ILL">ILL</option>
                    </select>
                </div>
                <div><label>Delivery Status</label><select name="deliveryStatus"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div>
                <div><label>Months</label><input name="months" type="number"></div>
                <div><label>Devices</label><input name="devices" type="number"></div>
                <div><label>Price for 1 device</label><input name="price" type="number"></div>
                <div><label>Total exclusive gst</label><input name="exclGst" type="number"></div>
                <div><label>Total inclusive gst</label><input name="inclGst" type="number"></div>
                <div><label>Payment Status</label><select name="paymentStatus"><option value="Unpaid">Unpaid</option><option value="Paid">Paid</option></select></div>
                <div><label>Payment Date</label><input type="date" name="paymentDate"></div>
                <div><label>Start Date</label><input type="date" name="startDate"></div>
                <div><label>End Date</label><input type="date" name="endDate"></div>
                <div><label>PO Expiry</label><input type="date" name="poExpiryDate"></div>
                <div><label>Service Status</label>
                    <select name="serviceStatus">
                        <option value="Active">Active</option>
                        <option value="Stop">Stop</option>
                    </select>
                </div>
                <div><label>Service Stop Date</label><input type="date" name="serviceStopDate"></div>
                <div><label>PO Renewed?</label><select name="poRenewed"><option value="Pending">Pending</option><option value="Renewed">Renewed</option></select></div>
                <div><label>Renewal Date</label><input type="date" name="poRenewalDate"></div>
            </div>
            <div style="margin-top:25px; text-align:right;">
                <button class="btn" type="button" onclick="closeModal()" style="background:#64748b; margin-right:10px;">Cancel</button>
                <button class="btn" type="submit">Save Record</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const supabaseUrl = "https://jhvujuqzkjbprmshizcx.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpodnVqdXF6a2picHJtc2hpemN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU0NjcsImV4cCI6MjA4NjIyMTQ2N30.sa2KCYFNKipT_vz_4uvWX4h5lD54Fw4DW2PFa8Tck6A";
    const dbClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let salesData = [];
    let editingId = null;

    async function handleLogin() {
        const { error } = await dbClient.auth.signInWithPassword({ email: loginEmail.value, password: loginPass.value });
        if (error) { errorMsg.innerText = error.message; errorMsg.style.display = 'block'; }
        else { authOverlay.style.display = 'none'; loadData(); }
    }

    async function handleLogout() { await dbClient.auth.signOut(); location.reload(); }

    async function loadData() {
        const { data, error } = await dbClient.from("sales_entries").select("*").order("id", { ascending: false });
        if (!error) { salesData = data; renderTable(data); }
    }

    function renderTable(data) {
        tableBody.innerHTML = data.map(item => {
            // Calculate 50-day warning
            const expiry = new Date(item.poExpiryDate);
            const today = new Date();
            const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
            const rowClass = (diffDays <= 50 && diffDays > 0) ? 'class="expiry-warning"' : '';

            return `
                <tr ${rowClass}>
                    <td>${item.clientName || ""}</td>
                    <td>${item.customerName || ""}</td>
                    <td>${item.speed || ""}</td>
                    <td>${item.location || ""}</td>
                    <td>${item.connectivity || ""}</td>
                    <td><span class="badge ${item.deliveryStatus === 'Active' ? 'bg-green' : 'bg-red'}">${item.deliveryStatus || ""}</span></td>
                    <td>${item.months || ""}</td>
                    <td>${item.devices || ""}</td>
                    <td>${item.price || ""}</td>
                    <td>${item.exclGst || ""}</td>
                    <td>${item.inclGst || ""}</td>
                    <td><span class="badge ${item.paymentStatus === 'Paid' ? 'bg-green' : 'bg-red'}">${item.paymentStatus || ""}</span></td>
                    <td>${item.paymentDate || ""}</td>
                    <td>${item.startDate || ""}</td>
                    <td>${item.endDate || ""}</td>
                    <td><strong>${item.poExpiryDate || ""}</strong></td>
                    <td><span class="badge ${item.serviceStatus === 'Active' ? 'bg-green' : 'bg-red'}">${item.serviceStatus || ""}</span></td>
                    <td>${item.serviceStopDate || ""}</td>
                    <td>${item.poRenewed || ""}</td>
                    <td>${item.poRenewalDate || ""}</td>
                    <td style="white-space:nowrap;">
                        <button onclick="editEntry(${item.id})">‚úèÔ∏è</button>
                        <button onclick="deleteEntry(${item.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function exportToCSV() {
        if(salesData.length === 0) return;
        const headers = ["Client Name,Customer Name,Speed,Location,Connectivity,Status,Months,Devices,Price per Device,Excl GST,Incl GST,Payment,Payment Date,Start Date,End Date,PO Expiry,Service Status,Stop Date,PO Renewed,Renewal Date"];
        const rows = salesData.map(i => [i.clientName, i.customerName, i.speed, i.location, i.connectivity, i.deliveryStatus, i.months, i.devices, i.price, i.exclGst, i.inclGst, i.paymentStatus, i.paymentDate, i.startDate, i.endDate, i.poExpiryDate, i.serviceStatus, i.serviceStopDate, i.poRenewed, i.poRenewalDate].join(","));
        const blob = new Blob([[headers, ...rows].join("\n")], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'Transmedia_Report.csv'; a.click();
    }

    function filterTable() {
        const q = searchInput.value.toLowerCase();
        renderTable(salesData.filter(i => (i.customerName || "").toLowerCase().includes(q) || (i.clientName || "").toLowerCase().includes(q)));
    }

    window.deleteEntry = async (id) => {
        if (!confirm("Delete entry?")) return;
        await dbClient.from("sales_entries").delete().eq("id", id);
        loadData();
    };

    salesForm.onsubmit = async (e) => {
        e.preventDefault();
        const entry = Object.fromEntries(new FormData(e.target).entries());
        Object.keys(entry).forEach(k => { if(entry[k] === "") entry[k] = null; });
        const { error } = editingId ? await dbClient.from("sales_entries").update(entry).eq("id", editingId) : await dbClient.from("sales_entries").insert([entry]);
        if (error) alert(error.message); else { closeModal(); loadData(); }
    };

    function openModal() { editingId = null; salesForm.reset(); modalOverlay.classList.add('open'); }
    function closeModal() { modalOverlay.classList.remove('open'); }
    
    window.editEntry = (id) => {
        editingId = id;
        const item = salesData.find(x => x.id === id);
        Object.keys(item).forEach(k => { if(salesForm.elements[k]) salesForm.elements[k].value = item[k] || ""; });
        modalOverlay.classList.add('open');
    };

    (async () => {
        const { data: { user } } = await dbClient.auth.getUser();
        if (user) { authOverlay.style.display = 'none'; loadData(); }
    })();
</script>
</body>
</html>
