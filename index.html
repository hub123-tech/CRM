<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enterprise Sales Tracker</title>

<style>
:root {
 --primary:#2563eb;
 --bg:#f8fafc;
 --surface:#ffffff;
 --text-main:#1e293b;
 --text-light:#64748b;
 --border:#e2e8f0;
}

body{ font-family:Arial; background:var(--bg); margin:0; padding:20px; }

header{
 display:flex; justify-content:space-between; align-items:center;
 background:white; padding:16px 24px; border-radius:12px; margin-bottom:20px;
 box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.btn{
 background:var(--primary); color:white; border:none;
 padding:10px 20px; border-radius:8px; cursor:pointer; font-weight: bold;
}

.table-container{ background:white; border-radius:12px; overflow:auto; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
table{ width:100%; border-collapse:collapse; }
th{ background:#f1f5f9; padding:12px; text-align:left; font-size: 14px; }
td{ padding:12px; border-bottom:1px solid var(--border); color:var(--text-light); font-size: 14px; }

.modal-overlay{
 position:fixed; top:0; left:0; width:100%; height:100%;
 background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
 z-index: 1000;
}

.modal-overlay.open{ display:flex; }
.modal{ background:white; width:90%; max-width:800px; border-radius:16px; padding:24px; }

.form-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:16px; }
input, select{ padding:10px; border:1px solid var(--border); border-radius:6px; width:100%; box-sizing:border-box; }

.actions-cell button{ cursor:pointer; margin-right:5px; border:none; background:none; font-size: 18px; }
</style>
</head>

<body>

<header>
<h2>üöÄ Sales & Service Tracker</h2>
<button class="btn" onclick="openModal()">+ Add New Entry</button>
</header>

<div class="table-container">
<table>
<thead>
<tr>
<th>Entity</th>
<th>Customer</th>
<th>Speed</th>
<th>Location</th>
<th>Connectivity</th>
<th>Status</th>
<th>Months</th>
<th>Devices</th>
<th>Price</th>
<th>Payment</th>
<th>PO Expiry</th>
<th>Service Stop</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableBody">
    <tr><td colspan="13" style="text-align:center">Loading data...</td></tr>
</tbody>
</table>
</div>

<div class="modal-overlay" id="modalOverlay">
<div class="modal">
<h3 id="modalTitle">New Entry</h3>
<form id="salesForm">
<div class="form-grid">
<input id="entity" name="entity" placeholder="Entity" required>
<input id="customerName" name="customerName" placeholder="Customer Name" required>
<input id="speed" name="speed" placeholder="Speed">
<input id="location" name="location" placeholder="Location">

<select id="connectivity" name="connectivity">
<option value="Fiber">Fiber</option>
<option value="Wireless">Wireless</option>
<option value="LTE/5G">LTE/5G</option>
</select>

<select id="deliveryStatus" name="deliveryStatus">
<option value="Pending">Pending</option>
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
</select>

<input id="months" name="months" type="number" placeholder="Months">
<input id="devices" name="devices" type="number" placeholder="Devices">
<input id="price" name="price" type="number" placeholder="Price">

<select id="paymentStatus" name="paymentStatus">
<option value="Unpaid">Unpaid</option>
<option value="Paid">Paid</option>
<option value="Overdue">Overdue</option>
</select>

<div><label>PO Expiry</label><input type="date" id="poExpiryDate" name="poExpiryDate"></div>
<div><label>Service Stop</label><input type="date" id="serviceStopDate" name="serviceStopDate"></div>
</div>

<div style="margin-top:20px; text-align:right;">
<button class="btn" type="button" onclick="closeModal()" style="background:#64748b">Cancel</button>
<button class="btn" type="submit">Save Record</button>
</div>
</form>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ======================
   SUPABASE CONFIG
====================== */
const supabaseUrl = "https://jhvujuqzkjbprmshizcx.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpodnVqdXF6a2picHJtc2hpemN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU0NjcsImV4cCI6MjA4NjIyMTQ2N30.sa2KCYFNKipT_vz_4uvWX4h5lD54Fw4DW2PFa8Tck6A";

const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

let salesData = [];
let editingId = null;

const modal = document.getElementById('modalOverlay');
const form = document.getElementById('salesForm');
const tableBody = document.getElementById('tableBody');

/* ======================
   FUNCTIONS
====================== */

// 1. OPEN MODAL (The fix: Ensure this is defined globally)
window.openModal = function() {
    editingId = null;
    document.getElementById('modalTitle').innerText = "New Entry";
    form.reset();
    modal.classList.add('open');
}

window.closeModal = function() {
    modal.classList.remove('open');
}

// 2. LOAD DATA
async function loadData() {
    const { data, error } = await supabase
        .from("sales_entries")
        .select("*")
        .order("id", { ascending: false });

    if (error) {
        console.error("Supabase Error:", error);
        tableBody.innerHTML = `<tr><td colspan="13" style="color:red">Error: ${error.message}. Make sure table 'sales_entries' exists.</td></tr>`;
        return;
    }

    salesData = data || [];
    renderTable();
}

// 3. RENDER TABLE
function renderTable() {
    tableBody.innerHTML = "";
    if (salesData.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='13' style='text-align:center'>No records found</td></tr>";
        return;
    }

    salesData.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${item.entity || ""}</td>
            <td>${item.customerName || ""}</td>
            <td>${item.speed || ""}</td>
            <td>${item.location || ""}</td>
            <td>${item.connectivity || ""}</td>
            <td><b>${item.deliveryStatus || ""}</b></td>
            <td>${item.months || ""}</td>
            <td>${item.devices || ""}</td>
            <td>${item.price || ""}</td>
            <td>${item.paymentStatus || ""}</td>
            <td>${item.poExpiryDate || ""}</td>
            <td>${item.serviceStopDate || ""}</td>
            <td class="actions-cell">
                <button onclick="editEntry(${item.id})">‚úèÔ∏è</button>
                <button onclick="deleteEntry(${item.id})">üóëÔ∏è</button>
            </td>
        `;
        tableBody.appendChild(tr);
    });
}

// 4. SAVE
form.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const entry = Object.fromEntries(formData.entries());

    try {
        if (editingId) {
            await supabase.from("sales_entries").update(entry).eq("id", editingId);
        } else {
            await supabase.from("sales_entries").insert([entry]);
        }
        closeModal();
        loadData();
    } catch (err) {
        alert("Error saving record!");
    }
};

// 5. EDIT/DELETE
window.editEntry = (id) => {
    const item = salesData.find(x => x.id === id);
    if (!item) return;
    editingId = id;
    document.getElementById('modalTitle').innerText = "Edit Entry";
    
    Object.keys(item).forEach(key => {
        const input = form.elements[key];
        if (input) input.value = item[key];
    });
    modal.classList.add('open');
};

window.deleteEntry = async (id) => {
    if (!confirm("Delete this record?")) return;
    await supabase.from("sales_entries").delete().eq("id", id);
    loadData();
};

// Start
loadData();
</script>

</body>
</html>
