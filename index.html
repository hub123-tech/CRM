<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Sales Tracker - Authorized Access</title>
    <style>
        :root { --primary:#2563eb; --bg:#f8fafc; --border:#e2e8f0; }
        body { font-family: Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        
        /* AUTH OVERLAY - Hide CRM until logged in */
        #authOverlay { position: fixed; inset: 0; background: #0f172a; display: flex; justify-content: center; align-items: center; z-index: 2000; color: white; }
        .auth-card { background: white; color: #1e293b; padding: 40px; border-radius: 16px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .auth-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        
        header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 16px 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); gap: 15px; }
        .controls { display: flex; gap: 10px; align-items: center; flex-grow: 1; justify-content: flex-end; }
        #searchInput { padding: 10px; border: 1px solid var(--border); border-radius: 8px; width: 100%; max-width: 300px; font-size: 14px; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        
        .badge { padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 11px; display: inline-block; text-transform: uppercase; border: 1px solid transparent; }
        .bg-green { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .bg-red { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .bg-yellow { background-color: #fef9c3; color: #854d0e; border-color: #fef08a; }
        .bg-gray { background-color: #f1f5f9; color: #475569; border-color: #e2e8f0; }

        .table-container { background: white; border-radius: 12px; overflow: auto; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 2200px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 11px; color: #475569; white-space: nowrap; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 12px; color: #1e293b; }
        
        .action-btns { display: flex; gap: 12px; align-items: center; }
        .action-btns button { cursor: pointer; border: none; background: none; font-size: 18px; padding: 0; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.open { display: flex; }
        .modal { background: white; width: 95%; max-width: 950px; border-radius: 16px; padding: 24px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        input, select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; width: 100%; box-sizing:border-box; font-size: 13px; }
        label { font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; color: #334155; }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-card">
        <h2>Transmedia CRM</h2>
        <p>Enter authorized credentials</p>
        <input type="email" id="loginEmail" placeholder="Email Address">
        <input type="password" id="loginPass" placeholder="Password">
        <button class="btn" style="width:100%" onclick="handleLogin()">Sign In</button>
        <p id="errorMsg" style="color:red; font-size:12px; display:none; margin-top:10px;"></p>
    </div>
</div>

<header>
    <h2 style="margin:0;">Transmedia Sales Tracker</h2>
    <div class="controls">
        <input type="text" id="searchInput" placeholder="Search Customer or Entity..." onkeyup="filterTable()">
        <button class="btn" onclick="openModal()">+ Add New Entry</button>
        <button class="btn" style="background:#64748b; margin-left:10px;" onclick="handleLogout()">Logout</button>
    </div>
</header>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Entity</th><th>Customer Name</th><th>Speed</th><th>Location</th><th>Connectivity</th>
                <th>Service Status</th><th>Months</th><th>Devices</th><th>Price</th><th>Excl. GST</th>
                <th>Incl. GST</th><th>Payment Status</th><th>Payment Date</th><th>Start Date</th>
                <th>End Date</th><th>PO Expiry</th><th>Stop Date</th><th>PO Renewed?</th><th>Renewal Date</th><th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="20" style="text-align:center">Waiting for authentication...</td></tr>
        </tbody>
    </table>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h3 id="modalTitle">Entry Details</h3>
        <form id="salesForm">
            <div class="form-grid">
                <div><label>Entity</label><input name="entity" required></div>
                <div><label>Customer Name</label><input name="customerName" required></div>
                <div><label>Speed (MBPS)</label><input name="speed"></div>
                <div><label>Service Location</label><input name="location"></div>
                <div><label>Connectivity Type</label>
                    <select name="connectivity">
                        <option value="Fiber">Fiber</option><option value="Wireless">Wireless</option><option value="LTE/5G">LTE/5G</option>
                    </select>
                </div>
                <div><label>Service Status</label>
                    <select name="deliveryStatus">
                        <option value="Active">Active</option><option value="Inactive">Inactive</option><option value="Pending">Pending</option>
                    </select>
                </div>
                <div><label>No. of Months</label><input name="months" type="number"></div>
                <div><label>No. of Devices</label><input name="devices" type="number"></div>
                <div><label>Price</label><input name="price" type="number"></div>
                <div><label>Excl. GST</label><input name="exclGst" type="number"></div>
                <div><label>Incl. GST</label><input name="inclGst" type="number"></div>
                <div><label>Payment Status</label>
                    <select name="paymentStatus">
                        <option value="Unpaid">Unpaid</option><option value="Paid">Paid</option>
                    </select>
                </div>
                <div><label>Payment Date</label><input type="date" name="paymentDate"></div>
                <div><label>Start Date</label><input type="date" name="startDate"></div>
                <div><label>End Date</label><input type="date" name="endDate"></div>
                <div><label>PO Expiry Date</label><input type="date" name="poExpiryDate"></div>
                <div><label>Service Stop Date</label><input type="date" name="serviceStopDate"></div>
                <div><label>PO Renewed?</label>
                    <select name="poRenewed">
                        <option value="Pending">Pending</option>
                        <option value="Renewed">Renewed</option>
                    </select>
                </div>
                <div><label>PO Renewal Date</label><input type="date" name="poRenewalDate"></div>
            </div>
            <div style="margin-top:25px; text-align:right;">
                <button class="btn" type="button" onclick="closeModal()" style="background:#64748b; margin-right: 10px;">Cancel</button>
                <button class="btn" type="submit">Save Record</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    const supabaseUrl = "https://jhvujuqzkjbprmshizcx.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpodnVqdXF6a2picHJtc2hpemN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU0NjcsImV4cCI6MjA4NjIyMTQ2N30.sa2KCYFNKipT_vz_4uvWX4h5lD54Fw4DW2PFa8Tck6A";
    const dbClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    let salesData = [];
    let editingId = null;

    // --- 1. AUTH LOGIC ---
    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPass').value;
        const { data, error } = await dbClient.auth.signInWithPassword({ email, password });

        if (error) {
            const errEl = document.getElementById('errorMsg');
            errEl.innerText = error.message;
            errEl.style.display = 'block';
        } else {
            document.getElementById('authOverlay').style.display = 'none';
            loadData();
        }
    }

    async function handleLogout() {
        await dbClient.auth.signOut();
        location.reload();
    }

    // Check if user is already logged in on page load
    async function checkUser() {
        const { data: { user } } = await dbClient.auth.getUser();
        if (user) {
            document.getElementById('authOverlay').style.display = 'none';
            loadData();
        }
    }

    // --- 2. DATA LOGIC ---
    async function loadData() {
        const { data, error } = await dbClient.from("sales_entries").select("*").order("id", { ascending: false });
        if (error) {
            if (error.code === "PGRST301") alert("Access Denied: Your email is not in the authorized list.");
            return;
        }
        salesData = data || [];
        renderTable(salesData);
    }

    function getStatusBadge(val) {
        if (!val) return `<span class="badge bg-gray">-</span>`;
        const lower = val.toLowerCase();
        let colorClass = "bg-gray";
        if (lower === 'paid' || lower === 'active' || lower === 'renewed') colorClass = "bg-green";
        else if (lower === 'unpaid' || lower === 'inactive') colorClass = "bg-red";
        else if (lower === 'pending') colorClass = "bg-yellow";
        return `<span class="badge ${colorClass}">${val}</span>`;
    }

    function renderTable(dataToRender) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = dataToRender.length ? "" : "<tr><td colspan='20' style='text-align:center'>No records found</td></tr>";
        dataToRender.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.entity || ""}</td>
                <td>${item.customerName || ""}</td>
                <td>${item.speed || ""}</td>
                <td>${item.location || ""}</td>
                <td>${item.connectivity || ""}</td>
                <td>${getStatusBadge(item.deliveryStatus)}</td>
                <td>${item.months || ""}</td>
                <td>${item.devices || ""}</td>
                <td>${item.price || ""}</td>
                <td>${item.exclGst || ""}</td>
                <td>${item.inclGst || ""}</td>
                <td>${getStatusBadge(item.paymentStatus)}</td>
                <td>${item.paymentDate || ""}</td>
                <td>${item.startDate || ""}</td>
                <td>${item.endDate || ""}</td>
                <td>${item.poExpiryDate || ""}</td>
                <td>${item.serviceStopDate || ""}</td>
                <td>${getStatusBadge(item.poRenewed)}</td>
                <td>${item.poRenewalDate || ""}</td>
                <td>
                    <div class="action-btns">
                        <button onclick="editEntry(${item.id})">‚úèÔ∏è</button>
                        <button onclick="deleteEntry(${item.id})">üóëÔ∏è</button>
                    </div>
                </td>`;
            tbody.appendChild(tr);
        });
    }

    function filterTable() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = salesData.filter(item => 
            (item.customerName && item.customerName.toLowerCase().includes(query)) ||
            (item.entity && item.entity.toLowerCase().includes(query))
        );
        renderTable(filtered);
    }

    function openModal() {
        editingId = null;
        document.getElementById('modalTitle').innerText = "New Entry";
        document.getElementById('salesForm').reset();
        document.getElementById('modalOverlay').classList.add('open');
    }
    function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }

    document.getElementById('salesForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const entry = Object.fromEntries(formData.entries());

        // CRITICAL FIX: Convert empty strings to NULL for database
        Object.keys(entry).forEach(key => {
            if (entry[key] === "" || entry[key] === undefined) {
                entry[key] = null;
            } else if (['months', 'devices', 'price', 'exclGst', 'inclGst'].includes(key)) {
                entry[key] = Number(entry[key]);
            }
        });

        const { error } = editingId 
            ? await dbClient.from("sales_entries").update(entry).eq("id", editingId)
            : await dbClient.from("sales_entries").insert([entry]);
        
        if (!error) { closeModal(); loadData(); }
        else alert("Save Error: " + error.message);
    };

    window.editEntry = (id) => {
        const item = salesData.find(x => x.id === id);
        if (!item) return;
        editingId = id;
        document.getElementById('modalTitle').innerText = "Edit Entry";
        const form = document.getElementById('salesForm');
        Object.keys(item).forEach(key => { if(form.elements[key]) form.elements[key].value = item[key] || ""; });
        document.getElementById('modalOverlay').classList.add('open');
    };

    window.deleteEntry = async (id) => {
        if (confirm("Delete permanently?")) {
            const { error } = await dbClient.from("sales_entries").delete().eq("id", id);
            if (error) alert("Delete error: " + error.message);
            else loadData();
        }
    };

    checkUser();
</script>
</body>
</html>
