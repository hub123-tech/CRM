<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enterprise Sales Tracker</title>

<style>
:root {
 --primary:#2563eb;
 --bg:#f8fafc;
 --surface:#ffffff;
 --text-main:#1e293b;
 --text-light:#64748b;
 --border:#e2e8f0;
 --danger:#ef4444;
}

body{
 font-family:Arial;
 background:var(--bg);
 margin:0;
 padding:20px;
}

header{
 display:flex;
 justify-content:space-between;
 background:white;
 padding:16px 24px;
 border-radius:12px;
 margin-bottom:20px;
}

.btn{
 background:var(--primary);
 color:white;
 border:none;
 padding:10px 20px;
 border-radius:8px;
 cursor:pointer;
}

.table-container{
 background:white;
 border-radius:12px;
 overflow:auto;
}

table{
 width:100%;
 border-collapse:collapse;
}

th{
 background:#f1f5f9;
 padding:12px;
 text-align:left;
}

td{
 padding:12px;
 border-bottom:1px solid var(--border);
 color:var(--text-light);
}

.modal-overlay{
 position:fixed;
 top:0;
 left:0;
 width:100%;
 height:100%;
 background:rgba(0,0,0,0.5);
 display:flex;
 justify-content:center;
 align-items:center;
 opacity:0;
 pointer-events:none;
 transition: opacity 0.2s;
}

.modal-overlay.open{
 opacity:1;
 pointer-events:auto;
}

.modal{
 background:white;
 width:90%;
 max-width:800px;
 border-radius:16px;
 padding:24px;
}

.form-grid{
 display:grid;
 grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
 gap:16px;
}

input,select{
 padding:10px;
 border:1px solid var(--border);
 border-radius:6px;
 width: 100%; /* Fix for alignment */
 box-sizing: border-box; /* Fix for padding */
}

.actions-cell button{
 margin-right:6px;
 cursor: pointer;
 border: 1px solid var(--border);
 background: white;
 padding: 5px 10px;
 border-radius: 4px;
}
</style>
</head>

<body>

<header>
<h2>üöÄ Sales & Service Tracker</h2>
<button class="btn" onclick="openModal()">+ Add New Entry</button>
</header>

<div class="table-container">
<table>
<thead>
<tr>
<th>Entity</th>
<th>Customer</th>
<th>Speed</th>
<th>Location</th>
<th>Connectivity</th>
<th>Status</th>
<th>Months</th>
<th>Devices</th>
<th>Price</th>
<th>Payment</th>
<th>PO Expiry</th>
<th>Service Stop</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<div class="modal-overlay" id="modalOverlay">
<div class="modal">
<h3>Entry Details</h3>
<br>
<form id="salesForm" onsubmit="handleFormSubmit(event)">
<input type="hidden" id="entryId">

<div class="form-grid">
<input id="entity" name="entity" placeholder="Entity" required>
<input id="customerName" name="customerName" placeholder="Customer Name" required>
<input id="speed" name="speed" placeholder="Speed (e.g. 100Mbps)">
<input id="location" name="location" placeholder="Location">

<select id="connectivity" name="connectivity">
<option value="" disabled selected>Select Connectivity</option>
<option>Fiber</option>
<option>Wireless</option>
<option>LTE/5G</option>
</select>

<select id="deliveryStatus" name="deliveryStatus">
<option value="" disabled selected>Select Status</option>
<option>Pending</option>
<option>Active</option>
<option>Inactive</option>
</select>

<input id="months" name="months" type="number" placeholder="Months">
<input id="devices" name="devices" type="number" placeholder="Devices">
<input id="price" name="price" type="number" placeholder="Price">

<select id="paymentStatus" name="paymentStatus">
<option value="" disabled selected>Payment Status</option>
<option>Unpaid</option>
<option>Paid</option>
<option>Overdue</option>
</select>

<div>
<label style="font-size:12px; color:#666">PO Expiry</label>
<input type="date" id="poExpiryDate" name="poExpiryDate">
</div>
<div>
<label style="font-size:12px; color:#666">Service Stop</label>
<input type="date" id="serviceStopDate" name="serviceStopDate">
</div>
</div>

<br>
<div style="text-align: right; margin-top: 20px;">
    <button class="btn" type="button" onclick="closeModal()" style="background: #94a3b8; margin-right: 10px;">Cancel</button>
    <button class="btn" type="submit">Save Record</button>
</div>

</form>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>

/* ======================
   SUPABASE CONNECTION
====================== */

// ‚ö†Ô∏è IMPORTANT: Use your 'anon' / 'public' key here. 
// It usually starts with "eyJh..." (JWT format).
const supabaseUrl = "https://jhvujuqzkjbprmshizcx.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpodnVqdXF6a2picHJtc2hpemN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU0NjcsImV4cCI6MjA4NjIyMTQ2N30.sa2KCYFNKipT_vz_4uvWX4h5lD54Fw4DW2PFa8Tck6A"; 

// Initialize Client Safely
let supabase = null;
if (supabaseUrl && supabaseKey && supabaseKey.length > 20 && !supabaseKey.includes("PASTE")) {
    try {
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    } catch (err) {
        console.error("Supabase Init Error:", err);
    }
} else {
    console.warn("‚ö†Ô∏è SUPABASE NOT CONNECTED: Check your URL and Key in the code.");
}

/* ======================
   STATE
====================== */

let salesData=[];
let editingId=null;

const modal=document.getElementById('modalOverlay');
const form=document.getElementById('salesForm');
const tableBody=document.getElementById('tableBody');

/* ======================
   MODAL FUNCTIONS
====================== */

function openModal(){
 editingId=null;
 form.reset();
 modal.classList.add('open');
}

function closeModal(){
 modal.classList.remove('open');
}

/* ======================
   LOAD DATA
====================== */

async function loadData(){
 if(!supabase) return; // Prevent crash if keys are missing

 const {data,error}=await supabase
 .from("sales_entries")
 .select("*")
 .order("id",{ascending:false});

 if(error){
     console.error("Error loading data:", error);
     return;
 }

 salesData=data||[];
 renderTable();
}

/* ======================
   SAVE ENTRY
====================== */

async function handleFormSubmit(e){
 e.preventDefault();
 
 if(!supabase) {
     alert("Cannot save: Supabase connection is missing. Please check your API Key in the code.");
     return;
 }

 const formData=new FormData(e.target);
 const entry=Object.fromEntries(formData.entries());

 // Clean up empty numbers to avoid DB errors
 if(entry.months === "") delete entry.months;
 if(entry.devices === "") delete entry.devices;
 if(entry.price === "") delete entry.price;

 try {
     let error;
     if(editingId){
      const res = await supabase.from("sales_entries").update(entry).eq("id",editingId);
      error = res.error;
     }else{
      const res = await supabase.from("sales_entries").insert([entry]);
      error = res.error;
     }

     if(error) throw error;

     closeModal();
     loadData();
 } catch (err) {
     alert("Error saving: " + err.message);
     console.error(err);
 }
}

/* ======================
   DELETE
====================== */

async function deleteEntry(id){
 if(!confirm("Delete this record?")) return;
 if(!supabase) return;

 const { error } = await supabase.from("sales_entries").delete().eq("id",id);
 
 if(error) {
     alert("Error deleting: " + error.message);
 } else {
     loadData();
 }
}

/* ======================
   EDIT
====================== */

function editEntry(id){
 const item=salesData.find(x=>x.id===id);
 if(!item) return;

 editingId=id;

 Object.keys(item).forEach(k=>{
  const el=document.getElementById(k);
  if(el) el.value=item[k];
 });

 modal.classList.add('open');
}

/* ======================
   RENDER TABLE
====================== */

function renderTable(){
 tableBody.innerHTML="";

 if(salesData.length === 0) {
     tableBody.innerHTML = "<tr><td colspan='13' style='text-align:center'>No records found</td></tr>";
     return;
 }

 salesData.forEach(item=>{
 tableBody.innerHTML+=`
 <tr>
 <td>${item.entity||""}</td>
 <td>${item.customerName||""}</td>
 <td>${item.speed||""}</td>
 <td>${item.location||""}</td>
 <td>${item.connectivity||""}</td>
 <td>${getStatusBadge(item.deliveryStatus)}</td>
 <td>${item.months||""}</td>
 <td>${item.devices||""}</td>
 <td>${item.price||""}</td>
 <td>${item.paymentStatus||""}</td>
 <td>${item.poExpiryDate||""}</td>
 <td>${item.serviceStopDate||""}</td>
 <td class="actions-cell">
 <button onclick="editEntry(${item.id})">‚úèÔ∏è</button>
 <button onclick="deleteEntry(${item.id})">üóëÔ∏è</button>
 </td>
 </tr>`;
 });
}

// Helper to make status look nice
function getStatusBadge(status) {
    if(!status) return "";
    let color = "#64748b";
    if(status === 'Active') color = "#16a34a";
    if(status === 'Pending') color = "#ca8a04";
    if(status === 'Inactive') color = "#dc2626";
    return `<span style="color:${color}; font-weight:bold">${status}</span>`;
}

/* ======================
   INITIAL LOAD
====================== */

loadData();

</script>

</body>
</html>
